# A2PC 在电商场景的应用

A2PC 旨在解决在分布式中的事务问题。在电商的场景中时常需要面对分布式事务的问题，而且对数据的一致性有着严格的要求，A2PC 在电商场景中能够低成本、高性能的解决分布式事务的问题。在 A2PC 实现之后，这里会以电商里的下单场景为例子介绍 A2PC 在业务中如何应用。在电商场景下，会有正向、逆向流程，其中正向流程又有很多步骤，这里只以下单为例子，在其他步骤的落地方式中一样。  

用户下单操作包括：
> - 创建订单
> - 扣除库存
> - 优惠券消耗/积分抵扣/购买资质消耗
> - 余额扣减

这 4 个操作需要在一个事务中，全部完成或者全部失败。在数据和并发量比较大的场景下 [分库分表](/pidal/sharding) 是比较常用、也是效果不错的方案。但是分库分表之后就很难完全避免分布式事务的问题，即便根据用户纬度做拆分，创建订单优、惠券抵扣、余额扣减这三个操作可以在一个本地事务中，但是商品库存就无法保障在一个本地事务甚至在一个机器上了。而且这种拆分会随着业务的增长逐步遇到单机瓶颈。所以在电商场景中随着业务的增长，分布式事务问题难以避免。

以上只说了分库分表，伴随着业务的增长、还有「[微服务](https://zh.wikipedia.org/wiki/微服務)」架构的日渐成熟，有企业会对下单操作中涉及的各方拆分为独立的服务，比如订单、库存、资产等独立的服务，各自负责订单状态扭转、库存操作、优惠券、积分、余额的用户资产相关操作。这样一个下单操作就变成了跨服务的分布式事务操作了。而且做了服务的拆分之后，依然还有会有分库分表的场景，不过这里解决分库分表引起的问题并不需要单独拎出来解决，A2PC 在解决跨服务事务的时候会一同解决。所以这里把下单操作分为两种场景：
1. 分库分表场景下下单操作
2. 跨服务下单操作

## 分库分表下单操作
在分库模式下，可以直接通过 PiDAL 作为数据库中间件，启用 [A2PC 事务模式](/pidal/transaction?id=a2pc-事务模式)可以直接解决分布式事务问题。业务方只需要使用 对应语言的 MySQL 驱动即可，PiDAL兼容 MySQL 的通讯协议，不需要额外的操作。另外基于 A2PC 的分布式事务解决方案，能减少网络通讯次数、减少数据的锁定周期进而提高系统的性能。在业务实现中可以参考一下思路来进行开发。

首先分析在下单操作中涉及的数据，
- 订单，依附用户而存在的，只有在同一个用户并发操作的时候才会出现锁竞争的场景。
- 库存，依附商品纬度的存在，在不同的用户购买同一个商品的时候就会出现锁竞争，不同用户购买同一个商品是一个常见的并发场景，在抢购、秒杀等活动下更为场景，相对而言，库存数据就是「热点数据」。
- 优惠券、积分、购买资质等等虚拟用户资产，是作为用户的属性或者抽象为用户资产而存在。和订单一样，只有在同一个用户并发操作的时候才会出现锁竞争。
- 余额，也是用户资产的一部分，和用户的虚拟资产一样，也是只会在同一个用户并发操作的时候才会出现锁竞争。

通过分析，下单操作中的 4 种数据，订单、优惠券、余额等相对来说锁竞争的概率很低，即便出现来锁竞争，锁等待的也是同一个用户。库存是「热点数据」，需要尽量减少库存数据的锁定周期，来避免其他用户下单时候锁等待的时间。在 A2PC 的分布式事务解决方案中支持对热点数据的优化，减少数据的锁定周期以提高系统的吞吐性能。在业务实现中，建议的操作顺序是：

> 1. 创建订单
> 2. 优惠券消耗/积分抵扣/购买资质消耗
> 3. 余额扣减
> 4. 扣除库存

最后一步才是「扣除库存」，把对热点数据的操作放到最后一步，这样锁定数据，操作扣除库存之后就可以提交整个事务了，减少不必要的等待，这样对热点数据的锁定周期非常短，每个下单操作的锁竞争等待时间也会少，也会减少出现锁经常的场景，进而提高系统的吞吐量。
除了性能之外，A2PC 把保障事务的 [ACID](https://zh.wikipedia.org/wiki/ACID) 作为第一要求，具体的实现和保证可以参见这里[A2PC 事务安全保障](/a2pc/introduction?id=事务保障)。

## 跨服务下单操作
在微服务架构下，一个下单操作需要在多个服务中进行操作，而且也需要保障这些服务之间的操作在同一个事务中，需要保障事务正确可靠。A2PC 也支持跨服务的分布式事务，跨服务落地 A2PC 的时候并不限制服务之间的通讯协议，无论是采用 gRPC、Thrift 还是自研的 RPC 协议都可以落地 A2PC。和分库分表一样，首先我们对下单操作中涉及的数据和服务做初步的分析。

- 订单，作为独立的服务存在，锁竞争也只会在同一个用户并发操作的时候才会出现。
- 库存，商品纬度的服务，在不同用户下单同一个商品的时候就会出现锁竞争，属于「热点数据」。
- 优惠券、积分、购买资质、余额等等一般都会归属到用户资产服务中去，当然也有在实践中将其中每一个不同的资产做了细分的服务，尤其是余额和积分这种服务，这两种服务的拆分对于落地 A2PC 而言区别不大，不在分开讨论。

一个下单操作共需要涉及订单、库存、用户资产三个服务的操作，其中用户资产可能会有多次操作。在跨服务的分布式事务中，落地 A2PC 也很容易，业务只需要在服务之间传递 [XID](/a2pc/specification?id=xid)即可，[TM](/a2pc/specification?id=tm) 角色和服务可以直接复用，无需额外开发，2PC 中的 [TM](/a2pc/specification?id=tm) 会协同和管理服务中涉及的所有操作，确保事务的正确和完整。


[A2PC](/a2pc/introduction) 是一个经过抽象的分布式事务协议，它有着广泛的适用性。在 A2PC 中 [TM](/a2pc/specification?id=tm)、[APP](/a2pc/specification?id=app) 这两个角色只限制了职责，并且限制落地的形式，比如对于 TM 而言 APP 可以是一个也可以是多个，即便是在同一个分布式事务中 APP 也可以是多个。在跨服务的事务中，就本质上来说，每个服务对于 TM 而言都是一个 APP，只是每个 APP 所操作的 [RM](/a2pc/specification?id=rm) 不同，都在一个事务中，而 TM 负责维护整个事务，不管具体是几个 APP、各自负责什么操作，只需要服务能够完成 APP 角色所负责的行为即可。而且基于 [A2PC 协议规范](/a2pc/specification) 实现的组件之间都可以兼容使用，减少在特殊场景下的落地成本。